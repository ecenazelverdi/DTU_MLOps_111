name: Continuous Model Learning

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "WandB Artifact Path (e.g., entity/project/artifact:version)"
        required: true
        type: string

jobs:
  test_and_promote:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install .
          # Ensure wandb is definitely installed if not picked up immediately (though it should be)
          pip install wandb pytest

      - name: Test Model
        env:
          MODEL_NAME: ${{ inputs.model_name }}
        run: |
          # Run the placeholder test
          pytest tests/performancetests/test_model.py

      - name: Promote Model to Production
        if: success()
        env:
          MODEL_NAME: ${{ inputs.model_name }}
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          WANDB_ENTITY: ${{ secrets.WANDB_ENTITY }}
          WANDB_PROJECT: ${{ secrets.WANDB_PROJECT }}
        run: |
          # Use the script to link the model to the 'production' command
          python scripts/link_model.py "$MODEL_NAME" -a production
